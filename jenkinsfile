pipeline {
  agent any
  environment {
    REGISTRY = "localhost:5000"
    IMAGE = "${REGISTRY}/my-website"
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build image') {
      steps {
        // Build using the Dockerfile inside the my-website folder
        sh 'docker build -f my-website/Dockerfile -t ${IMAGE}:${BUILD_NUMBER} my-website'
      }
    }

    stage('Push image') {
      steps {
        sh 'docker push ${IMAGE}:${BUILD_NUMBER}'
      }
    }

    stage('Deploy') {
      steps {
        sh '''
          docker rm -f my-website || true
          docker run -d --name my-website -p 8081:80 --restart=always ${IMAGE}:${BUILD_NUMBER}
        '''
      }
    }

    stage('Health check') {
      steps {
        sh '''
          for i in $(seq 1 6); do
            HTTP=$(docker run --rm --network container:my-website curlimages/curl:latest -s -o /dev/null -w "%{http_code}" http://localhost || true)
            echo "HTTP => $HTTP"
            if [ "$HTTP" = "200" ]; then
              echo "Health check ok"
              exit 0
            fi
            sleep 5
          done
          echo "Health check FAILED"
          exit 1
        '''
      }
    }
  }
  post {
    failure {
      echo "Pipeline failed. Check console output and container logs: docker logs my-website"
    }
  }
}
